const showModalButton=document.querySelector(".show-modal"),feedContainer=document.querySelector(".feed-container"),postModal=document.querySelector("#post-modal"),toastContainer=document.querySelector("#notification-toast"),form=document.querySelector("form"),titleInput=document.querySelector("#post_title"),locationInput=document.querySelector("#post_location"),imagePickerArea=document.querySelector(".image-picker-container"),videoPlayer=document.querySelector("video#player"),captureButton=document.querySelector("#capture-btn"),canvasElement=document.querySelector("canvas#canvas"),pickedImage=document.querySelector("#picked-image"),imagePicker=document.querySelector("#image-picker"),pickedImageText=document.querySelector("#image-picker-text"),getLocationBtn=document.querySelector("#get-location-btn"),locationSpinner=document.querySelector("#location-spinner"),locationBtnContainer=document.querySelector(".location-btn-container");let picture,fetchedLocation;function captureImage(){videoPlayer.style.display="none",canvasElement.style.display="block",canvas.width=videoPlayer.videoWidth,canvas.height=videoPlayer.videoHeight,canvas.getContext("2d").drawImage(videoPlayer,0,0,videoPlayer.videoWidth,videoPlayer.videoHeight),picture=dataURItoBlob(canvasElement.toDataURL()),closeVideoPlayer()}function closeVideoPlayer(){videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(function(e){e.stop()})}function checkGeolocationFeature(){navigator.geolocation||(locationBtnContainer.style.display="none")}function getLocation(e){var{latitude:t,longitude:e}=e.coords;fetch(`${GEOCODING_API_URL}?key=${GEOCODING_API_KEY}&lat=${t}&lon=${e}&format=json`).then(function(e){return e.json()}).then(function(e){var t=e.address.city||e.address.state;fetchedLocation=`In ${t||""}${t?", ":""}${e.address.country}`,locationInput.value=fetchedLocation,locationInput.parentElement.classList.add("is-focused","is-dirty"),getLocationBtn.style.display="inline-block",locationSpinner.style.display="none"}).catch(function(e){getLocationBtn.style.display="inline-block",locationSpinner.style.display="none",alert("Sorry, couldn't fetch the location, Please type manually")})}function getLocationCoordinates(){navigator.geolocation.getCurrentPosition(getLocation,function(e){getLocationBtn.style.display="inline-block",locationSpinner.style.display="none",alert("Sorry, couldn't fetch the location, Please type manually")},{timeout:5e3})}function initializeMedia(){navigator.mediaDevices||(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(o){let n=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return n?new Promise(function(e,t){n.call(navigator,o,e,t)}):Promise.reject(new Error("Browser does not support getUserMedia"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(function(e){videoPlayer.srcObject=e,videoPlayer.style.display="block",imagePicker.removeAttribute("required"),captureButton.addEventListener("click",captureImage)}).catch(function(e){imagePickerArea.style.display="block",imagePicker.setAttribute("required",!0),captureButton.style.display="none"})}function showModal(){let e=document.querySelectorAll("input");e.forEach(function(e){e.value="",e.parentElement.classList.remove("is-invalid")}),postModal.style.display="block",initializeMedia(),checkGeolocationFeature()}function closeModal(){clearInput(),closeVideoPlayer(),postModal.style.display="none",videoPlayer.style.display="none",imagePickerArea.style.display="none",picture=void 0,canvasElement.getContext("2d").clearRect(0,0,canvasElement.width,canvasElement.height),canvasElement.style.display="none",getLocationBtn.style.display="inline-block",locationSpinner.style.display="none"}function clearCards(){for(;feedContainer.hasChildNodes();)feedContainer.removeChild(feedContainer.lastChild)}function clearInput(){let e=document.querySelectorAll("input");e.forEach(function(e){e.value="",e.parentElement.classList.remove("is-dirty","is-focused","is-invalid")}),pickedImage.style.display="none",pickedImage.src=""}function createCard({id:e,image:t,title:o,location:n}){const a=document.createElement("div");a.className="demo-card-wide mdl-card mdl-shadow--2dp",a.id=e;const i=document.createElement("div");i.className="mdl-card__title",i.style.backgroundImage=`url(${t})`;const c=document.createElement("h2");c.className="mdl-card__title-text",c.textContent=o,i.appendChild(c),a.appendChild(i);const l=document.createElement("div");l.className="mdl-card__supporting-text text-center",l.textContent=n,a.appendChild(l),componentHandler.upgradeElement(a),feedContainer.appendChild(a)}function updateUI(e){for(var t in clearCards(),e)createCard(e[t])}getLocationBtn.addEventListener("click",function(){this.style.display="none",locationSpinner.style.display="inline-block",getLocationCoordinates()}),showModalButton.addEventListener("click",showModal),postModal.querySelector(".close").addEventListener("click",closeModal);let networkDataReceived=!1;function showNotifications(e){toastContainer.MaterialSnackbar.showSnackbar({message:e})}fetch(`${SERVER_DOMAIN}/getPosts`).then(function(e){return console.log("From Networks",e),e.json()}).then(function(e){networkDataReceived=!0,updateUI(e)}).catch(function(e){}),window.indexedDB&&readData("feed-posts").then(function(e){console.log("From Cache",e),networkDataReceived||updateUI(e)});async function sendData(e){const t=new FormData;t.append("id",e.id),t.append("location",e.location),t.append("title",e.title),t.append("image",e.image,e.id+"."+e.image.type.split("/").pop().toLowerCase()),fetch(`${SERVER_DOMAIN}/savePost`,{method:"POST",body:t}).then(function(e){showNotifications("Your post has been successfully posted")}).catch(function(e){showNotifications("Your post has been saved for syncing!")})}form.addEventListener("submit",function(e){e.preventDefault(),""!==titleInput.value.trim()&&""!==locationInput.value.trim()?(picture=picture||imagePicker.files[0],picture?(e={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,image:picture},closeModal(),clearInput(),sendData(e)):alert("Please pick an Image!")):alert("Please enter valid data!")}),imagePicker.onchange=function(){pickedImageText.value=this.files[0].name,pickedImage.style.display="block",pickedImage.src=URL.createObjectURL(this.files[0]),pickedImage.onload=function(){URL.revokeObjectURL(pickedImage.src)}};